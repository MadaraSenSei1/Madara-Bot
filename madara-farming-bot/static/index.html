<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Travian Farm Bot Dashboard</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .hidden { display: none; }
    .btn { padding: .5rem 1rem; margin: .5rem 0; }
    #farm-list ul { list-style: disc; margin-left: 2rem; }
    #farm-list .error { color: red; }
    label { display: block; margin-top: 1rem; }
    input[type=text], input[type=password], input[type=number] { width: 100%; padding: .4rem; }
  </style>
</head>
<body>
  <h1>Travian Farm Bot</h1>

  <!-- LOGIN FORM -->
  <div id="login-form">
    <label>Username:
      <input id="username" type="text">
    </label>
    <label>Password:
      <input id="password" type="password">
    </label>
    <label>Server URL (e.g. https://ts9.x1.europe.travian.com):
      <input id="server_url" type="text">
    </label>
    <label>Proxy IP:
      <input id="proxy_ip" type="text">
    </label>
    <label>Proxy Port:
      <input id="proxy_port" type="number">
    </label>
    <label>Proxy Username:
      <input id="proxy_user" type="text">
    </label>
    <label>Proxy Password:
      <input id="proxy_pass" type="password">
    </label>
    <button id="btn-login" class="btn">Login</button>
    <div id="login-msg"></div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">
    <p>Logged in as: <b id="dash-username"></b>
      <button id="btn-logout" class="btn">Logout</button>
    </p>

    <label>Minimum Interval (minutes):
      <input id="interval_min" type="number" value="10">
    </label>
    <label>Maximum Interval (minutes):
      <input id="interval_max" type="number" value="15">
    </label>
    <label><input id="random_delay" type="checkbox"> + Random Delay 0â€“30 seconds</label>

    <button id="btn-start" class="btn">â–¶ Start Bot</button>
    <button id="btn-refresh" class="btn">ðŸ”„ Refresh Farm Lists</button>

    <div id="farm-list">
      <h2>Available Farm Lists</h2>
      <div id="farm-loading">Loadingâ€¦</div>
      <ul id="farm-items"></ul>
      <div id="farm-error" class="error"></div>
    </div>
  </div>

  <script>
    const loginForm = document.getElementById("login-form");
    const dashboard = document.getElementById("dashboard");
    let currentUser = "";

    document.getElementById("btn-login").onclick = async () => {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      const srv = document.getElementById("server_url").value;
      const pi = document.getElementById("proxy_ip").value;
      const pp = document.getElementById("proxy_port").value;
      const pu = document.getElementById("proxy_user").value;
      const pw = document.getElementById("proxy_pass").value;

      const res = await fetch("/login", {
        method: "POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body: new URLSearchParams({ username:u, password:p, server_url:srv,
                                    proxy_ip:pi, proxy_port:pp,
                                    proxy_user:pu, proxy_pass:pw })
      });
      const j = await res.json();
      if (res.ok) {
        currentUser = u;
        loginForm.classList.add("hidden");
        dashboard.classList.remove("hidden");
        document.getElementById("dash-username").innerText = u;
        loadFarmLists();
      } else {
        document.getElementById("login-msg").innerText = j.error || j.message;
      }
    };

    document.getElementById("btn-logout").onclick = () => {
      currentUser = "";
      loginForm.classList.remove("hidden");
      dashboard.classList.add("hidden");
    };

    async function loadFarmLists() {
      document.getElementById("farm-loading").style.display = "block";
      document.getElementById("farm-items").innerHTML = "";
      document.getElementById("farm-error").innerText = "";
      try {
        const res = await fetch(`/farmlist?username=${encodeURIComponent(currentUser)}`);
        const j = await res.json();
        if (!res.ok) throw new Error(j.error || "Failed");
        j.farms.forEach(name => {
          const li = document.createElement("li");
          li.innerText = name;
          document.getElementById("farm-items").append(li);
        });
      } catch (err) {
        document.getElementById("farm-error").innerText = err.message;
      } finally {
        document.getElementById("farm-loading").style.display = "none";
      }
    }
    document.getElementById("btn-refresh").onclick = loadFarmLists;

    document.getElementById("btn-start").onclick = async () => {
      const min = document.getElementById("interval_min").value;
      const max = document.getElementById("interval_max").value;
      const rnd = document.getElementById("random_delay").checked;
      await fetch("/start-bot", {
        method: "POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          username: currentUser,
          interval_min: min,
          interval_max: max,
          random_delay: rnd
        })
      });
      alert("Bot started in background.");
    };
  </script>
</body>
</html>
