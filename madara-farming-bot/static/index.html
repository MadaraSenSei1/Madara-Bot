<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Madara Farm Bot</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    .card { border:1px solid #ccc; padding:1rem; margin-bottom:1rem; border-radius:4px; }
    button { padding:.5rem 1rem; }
    input { width: 4rem; }
    pre{ background:#f9f9f9; padding:1rem; overflow:auto; }
  </style>
</head>
<body>
  <h1>Madara Farm Bot</h1>
  <button onclick="addAccount()">➕ Add Account</button>
  <div id="accounts"></div>

  <template id="tpl-account">
    <div class="card" data-id="">
      <h2>Account <span class="aid"></span></h2>
      <div>
        <label>Username: <input class="username"/></label><br/>
        <label>Password: <input type="password" class="password"/></label><br/>
        <label>Server: <input class="server_url" value="https://ts9.x1.europe.travian.com"/></label><br/>
        <label>Proxy IP: <input class="proxy_ip"/></label>
        <label>Port: <input class="proxy_port"/></label><br/>
        <label>Proxy User: <input class="proxy_user"/></label>
        <label>Pass: <input class="proxy_pass" type="password"/></label><br/>
        <hr/>
        <label>Min (min): <input class="min_iv" type="number" value="10"/></label>
        <label>Max (min): <input class="max_iv" type="number" value="15"/></label>
        <label><input class="rand30" type="checkbox"/> +0–30 s</label><br/>
        <button class="btn-start">▶ Start</button>
        <button class="btn-stop">■ Stop</button>
      </div>
      <div>
        <strong>nächster Raid in: </strong>
        <span class="next_wait">–</span>s
      </div>
      <pre class="logs"></pre>
    </div>
  </template>

  <script>
    async function api(path, method="GET", body){
      const opts = {method, headers:{}};
      if(body) {
        opts.headers["Content-Type"]="application/json";
        opts.body=JSON.stringify(body);
      }
      const res = await fetch(path, opts);
      return res.json();
    }

    async function refreshStatus(aid, card){
      const st = await api(`/api/accounts/${aid}/status`);
      card.querySelector(".next_wait").textContent = st.next_wait;
      card.querySelector(".logs").textContent = st.logs.join("\n");
      // auto-update alle 1s, falls running
      if(st.running) setTimeout(()=>refreshStatus(aid,card),1000);
    }

    async function addAccount(){
      // schicke Daten an Server
      const tpl = document.getElementById("tpl-account");
      const clone = tpl.content.cloneNode(true);
      const card = clone.querySelector(".card");
      document.getElementById("accounts").appendChild(clone);
      const aid = await api("/api/accounts", "POST", {username:"",password:"",server_url:""}).id;
      card.dataset.id=aid;
      card.querySelector(".aid").textContent=aid;

      // Button‑Handler
      card.querySelector(".btn-start").onclick = async () => {
        const cfg = {
          min_interval: parseInt(card.querySelector(".min_iv").value),
          max_interval: parseInt(card.querySelector(".max_iv").value),
          rand30:       card.querySelector(".rand30").checked
        };
        await api(`/api/accounts/${aid}/interval`,"POST",cfg);
        await api(`/api/accounts/${aid}/start`,"POST");
        refreshStatus(aid, card);
      };
      card.querySelector(".btn-stop").onclick = async () => {
        await api(`/api/accounts/${aid}/stop`,"POST");
      };
    }
  </script>
</body>
</html>
