<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Travian Farming Bot</title>
    <script defer>
        let currentUser = "";

        async function handleLogin() {
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            const server = document.getElementById("server").value.trim();
            const proxy = document.getElementById("proxy").value.trim();

            if (!username || !password || !server) {
                alert("Please fill in all fields.");
                return;
            }

            const form = new FormData();
            form.append("username", username);
            form.append("password", password);
            form.append("server_url", server);
            form.append("proxy_ip", proxy.split(":")[0] || "");
            form.append("proxy_port", proxy.split(":")[1] || "");
            form.append("proxy_user", "");
            form.append("proxy_pass", "");

            try {
                const res = await fetch("/login", {
                    method: "POST",
                    body: form
                });
                const data = await res.json();

                if (res.ok) {
                    currentUser = username;
                    document.getElementById("login-section").classList.add("hidden");
                    document.getElementById("bot-section").classList.remove("hidden");
                    loadFarmLists();
                } else {
                    alert("Login failed: " + (data?.error || "Unknown error"));
                }
            } catch (err) {
                alert("Login error: " + err);
            }
        }

        async function loadFarmLists() {
            const listElement = document.getElementById("farm-list");
            listElement.innerHTML = "<li>Loading...</li>";
            try {
                const res = await fetch(`/farmlist?username=${currentUser}`);
                const data = await res.json();

                if (res.ok) {
                    listElement.innerHTML = "";
                    data.farms.forEach(farm => {
                        const li = document.createElement("li");
                        li.textContent = farm;
                        listElement.appendChild(li);
                    });
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                listElement.innerHTML = `<li style="color:red;">Failed to load farm lists<br>${err.message}</li>`;
            }
        }

        async function startBot() {
            const min = document.getElementById("min-interval").value;
            const max = document.getElementById("max-interval").value;

            const form = new FormData();
            form.append("username", currentUser);
            form.append("interval_min", min);
            form.append("interval_max", max);

            try {
                const res = await fetch("/start-bot", {
                    method: "POST",
                    body: form
                });

                const data = await res.json();
                alert(res.ok ? "Bot started successfully" : "Error: " + data.error);
            } catch (err) {
                alert("Start error: " + err.message);
            }
        }
    </script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<div id="login-section">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <input type="text" id="server" placeholder="https://ts9.x1.europe.travian.com"><br><br>
    <input type="text" id="proxy" placeholder="Proxy (IP:PORT optional)"><br><br>
    <button onclick="handleLogin()">Login</button>
</div>

<div id="bot-section" class="hidden">
    <h2>Raid Settings</h2>
    <label>Minimum Interval (min): <input type="number" id="min-interval" value="10"></label><br><br>
    <label>Maximum Interval (min): <input type="number" id="max-interval" value="15"></label><br><br>
    <button onclick="startBot()">Start Bot</button>

    <h2>Farm Lists <button onclick="loadFarmLists()">Refresh</button></h2>
    <ul id="farm-list"></ul>
</div>

</body>
</html>
