<!-- static/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Travian Farming Bot</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="container mx-auto">
    <h1 class="text-3xl font-bold mb-6">Travian Farming Bot</h1>
    <div id="accountsContainer" class="space-y-8"></div>
    <button onclick="addAccount()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700">
      ‚ûï Add Account
    </button>
  </div>

  <script>
    let accountCount = 0;

    function addAccount() {
      const container = document.getElementById("accountsContainer");
      const id = `account-${accountCount++}`;
      const accountHTML = `
        <div id="${id}" class="bg-white p-6 rounded shadow space-y-4">
          <h2 class="text-xl font-semibold mb-2">Travian Account</h2>
          <div class="grid grid-cols-2 gap-4">
            <input placeholder="Username" class="border p-2 rounded" id="${id}-username">
            <input placeholder="Password" type="password" class="border p-2 rounded" id="${id}-password">
            <input placeholder="Server URL (e.g. https://ts5.travian.com)" class="col-span-2 border p-2 rounded" id="${id}-server">

            <input placeholder="Proxy IP" class="border p-2 rounded" id="${id}-proxy-ip">
            <input placeholder="Port" class="border p-2 rounded" id="${id}-proxy-port">
            <input placeholder="Proxy Username" class="border p-2 rounded" id="${id}-proxy-user">
            <input placeholder="Proxy Password" type="password" class="border p-2 rounded" id="${id}-proxy-pass">
          </div>

          <button onclick="login('${id}')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            üîê Login
          </button>

          <div class="mt-4 space-y-2 hidden" id="${id}-config">
            <h3 class="text-lg font-medium">Farm Settings</h3>
            <div class="grid grid-cols-2 gap-4">
              <input type="number" placeholder="Min Interval (min)" class="border p-2 rounded" id="${id}-interval-min">
              <input type="number" placeholder="Max Interval (min)" class="border p-2 rounded" id="${id}-interval-max">
            </div>
            <label class="flex items-center mt-2">
              <input type="checkbox" class="mr-2" id="${id}-random-delay"> Randomize ¬±30s
            </label>

            <div class="flex items-center space-x-4 mt-4">
              <button onclick="startBot('${id}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">‚ñ∂Ô∏è Start Bot</button>
              <button onclick="stopBot('${id}')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">‚èπÔ∏è Stop Bot</button>
              <span id="${id}-countdown" class="text-sm text-gray-600"></span>
            </div>

            <div class="mt-4">
              <h4 class="font-semibold">Farm List</h4>
              <pre id="${id}-farm-list" class="bg-gray-100 p-2 rounded text-sm overflow-x-auto">Loading...</pre>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML("beforeend", accountHTML);
    }

    async function login(id) {
      const username = document.getElementById(`${id}-username`).value;
      const password = document.getElementById(`${id}-password`).value;
      const server_url = document.getElementById(`${id}-server`).value;
      const proxy_ip = document.getElementById(`${id}-proxy-ip`).value;
      const proxy_port = document.getElementById(`${id}-proxy-port`).value;
      const proxy_user = document.getElementById(`${id}-proxy-user`).value;
      const proxy_pass = document.getElementById(`${id}-proxy-pass`).value;

      const response = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username,
          password,
          server_url,
          proxy: {
            ip: proxy_ip,
            port: proxy_port,
            username: proxy_user,
            password: proxy_pass
          }
        })
      });

      const data = await response.json();

      if (response.ok) {
        document.getElementById(`${id}-config`).classList.remove("hidden");
        const farmListEl = document.getElementById(`${id}-farm-list`);
        farmListEl.textContent = JSON.stringify(data.farm_lists, null, 2);
        alert("‚úÖ Login successful!");
      } else {
        alert("‚ùå Login failed: " + data.detail);
      }
    }

    function startBot(id) {
      const interval_min = parseInt(document.getElementById(`${id}-interval-min`).value);
      const interval_max = parseInt(document.getElementById(`${id}-interval-max`).value);
      const random_delay = document.getElementById(`${id}-random-delay`).checked;

      fetch('/start-bot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ account_id: id, interval_min, interval_max, random_delay })
      });

      startCountdown(id, interval_min, interval_max, random_delay);
    }

    function stopBot(id) {
      fetch('/stop-bot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ account_id: id })
      });
      document.getElementById(`${id}-countdown`).textContent = "Bot stopped.";
    }

    function startCountdown(id, min, max, randomize) {
      const countdownEl = document.getElementById(`${id}-countdown`);
      let seconds = Math.floor((Math.random() * (max - min) + min) * 60);
      if (randomize) seconds += Math.floor(Math.random() * 61) - 30;

      const interval = setInterval(() => {
        if (seconds <= 0) {
          countdownEl.textContent = "Sending next raid...";
          clearInterval(interval);
        } else {
          const m = Math.floor(seconds / 60);
          const s = seconds % 60;
          countdownEl.textContent = `Next raid in ${m}m ${s}s`;
          seconds--;
        }
      }, 1000);
    }
  </script>
</body>
</html>
