<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Travian Farming Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
    <div class="max-w-3xl mx-auto mt-10 p-6 bg-white rounded shadow">
        <h1 class="text-3xl font-bold mb-4 text-center">Travian Farming Bot</h1>

        <div id="login-section">
            <form id="login-form" class="space-y-4">
                <input id="username" type="text" placeholder="Username" class="w-full border p-2 rounded" required />
                <input id="password" type="password" placeholder="Password" class="w-full border p-2 rounded" required />
                <input id="server" type="text" placeholder="https://ts9.x1.europe.travian.com" class="w-full border p-2 rounded" required />
                <input id="proxy" type="text" placeholder="Optional Proxy (IP:Port)" class="w-full border p-2 rounded" />
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Login</button>
            </form>
        </div>

        <div id="main-section" class="hidden mt-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <strong>Username:</strong> <span id="display-username"></span><br />
                    <strong>Server:</strong> <span id="display-server"></span>
                </div>
                <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
            </div>

            <h2 class="text-xl font-semibold mb-2">Farm Lists</h2>
            <div class="flex justify-between items-center mb-2">
                <span>Available Farm Lists:</span>
                <button id="refresh-farms" class="text-green-600 hover:underline">üîÑ Refresh</button>
            </div>
            <ul id="farm-list" class="list-disc ml-5 text-gray-700"></ul>
            <div id="farm-error" class="text-red-500 mt-2 hidden">‚ö†Ô∏è Failed to load farm lists</div>
        </div>
    </div>

    <script>
        let currentUser = "";

        document.getElementById("login-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            const server = document.getElementById("server").value.trim();
            const proxy = document.getElementById("proxy").value.trim();

            const [proxy_ip, proxy_port] = proxy.includes(":") ? proxy.split(":") : ["", ""];

            const formData = new FormData();
            formData.append("username", username);
            formData.append("password", password);
            formData.append("server_url", server);
            formData.append("proxy_ip", proxy_ip);
            formData.append("proxy_port", proxy_port);
            formData.append("proxy_user", "");
            formData.append("proxy_pass", "");

            try {
                const res = await fetch("/login", {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();
                if (res.ok) {
                    currentUser = username;
                    document.getElementById("login-section").classList.add("hidden");
                    document.getElementById("main-section").classList.remove("hidden");
                    document.getElementById("display-username").textContent = username;
                    document.getElementById("display-server").textContent = server;
                    loadFarmLists();
                } else {
                    alert("Login failed: " + data.error);
                }
            } catch (err) {
                alert("Error connecting to server.");
            }
        });

        document.getElementById("refresh-farms").addEventListener("click", async () => {
            loadFarmLists();
        });

        document.getElementById("logout-btn").addEventListener("click", () => {
            currentUser = "";
            document.getElementById("main-section").classList.add("hidden");
            document.getElementById("login-section").classList.remove("hidden");
            document.getElementById("farm-list").innerHTML = "";
        });

        async function loadFarmLists() {
            const list = document.getElementById("farm-list");
            const errorMsg = document.getElementById("farm-error");
            list.innerHTML = "";
            errorMsg.classList.add("hidden");

            try {
                const res = await fetch(`/farmlist?username=${encodeURIComponent(currentUser)}`);
                const data = await res.json();
                if (res.ok && Array.isArray(data.farms)) {
                    data.farms.forEach(farm => {
                        const li = document.createElement("li");
                        li.textContent = farm;
                        list.appendChild(li);
                    });
                } else {
                    errorMsg.textContent = "‚ö†Ô∏è Keine Farm-Listen gefunden";
                    errorMsg.classList.remove("hidden");
                }
            } catch (err) {
                errorMsg.textContent = "‚ö†Ô∏è Fehler beim Laden der Farm-Listen";
                errorMsg.classList.remove("hidden");
            }
        }
    </script>
</body>
</html>
