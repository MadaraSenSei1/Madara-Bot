<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Travian Farming Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-4">Farm Bot Dashboard</h1>

    <!-- LOGIN FORM -->
    <div id="login-section">
      <form id="login-form">
        <div class="mb-3">
          <label class="form-label">Username</label>
          <input type="text" class="form-control" id="username" name="username" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="password" name="password" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Server URL</label>
          <input type="url" class="form-control" id="server_url" name="server_url"
                 placeholder="https://ts9.x1.europe.travian.com" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Proxy IP</label>
          <input type="text" class="form-control" id="proxy_ip" name="proxy_ip">
        </div>
        <div class="mb-3">
          <label class="form-label">Proxy Port</label>
          <input type="text" class="form-control" id="proxy_port" name="proxy_port">
        </div>
        <div class="mb-3">
          <label class="form-label">Proxy Username</label>
          <input type="text" class="form-control" id="proxy_user" name="proxy_user">
        </div>
        <div class="mb-3">
          <label class="form-label">Proxy Password</label>
          <input type="password" class="form-control" id="proxy_pass" name="proxy_pass">
        </div>
        <button class="btn btn-primary" type="submit">Login</button>
      </form>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" style="display:none;">
      <p>Logged in as: <strong id="display-username"></strong></p>

      <div class="mb-3">
        <label class="form-label">Minimum Interval (minutes)</label>
        <input type="number" class="form-control" id="min-interval" value="10" min="1">
      </div>
      <div class="mb-3">
        <label class="form-label">Maximum Interval (minutes)</label>
        <input type="number" class="form-control" id="max-interval" value="15" min="1">
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="random-seconds">
        <label class="form-check-label">Random Delay: 0â€“30 seconds</label>
      </div>

      <button class="btn btn-success mb-2" id="start-bot-btn">â–¶ Start Bot</button>
      <button class="btn btn-secondary mb-2" id="refresh-btn">ðŸ”„ Refresh Farm Lists</button>

      <h3>Available Farm Lists</h3>
      <ul id="farm-lists-container" class="list-group"></ul>
    </div>
  </div>

  <script>
    // Login handler
    document.getElementById("login-form").onsubmit = async e => {
      e.preventDefault();
      const form = new FormData(e.target);
      const res = await fetch("/login", { method: "POST", body: form });
      const json = await res.json();
      if (res.ok) {
        const user = form.get("username");
        document.getElementById("display-username").textContent = user;
        document.getElementById("login-section").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        loadFarmLists();
      } else {
        alert("Login failed: " + json.error);
      }
    };

    // Load farm lists
    async function loadFarmLists() {
      const user = document.getElementById("username").value;
      const res = await fetch(`/farmlist?username=${encodeURIComponent(user)}`);
      const json = await res.json();
      const container = document.getElementById("farm-lists-container");
      container.innerHTML = "";
      if (res.ok) {
        json.farms.forEach(f => {
          const li = document.createElement("li");
          li.className = "list-group-item";
          li.textContent = f;
          container.appendChild(li);
        });
      } else {
        const li = document.createElement("li");
        li.className = "list-group-item text-danger";
        li.textContent = "Error: " + json.error;
        container.appendChild(li);
      }
    }

    // Refresh button
    document.getElementById("refresh-btn").onclick = loadFarmLists;

    // Start Bot handler
    document.getElementById("start-bot-btn").onclick = async () => {
      const form = new FormData();
      form.set("username", document.getElementById("username").value);
      form.set("interval_min", document.getElementById("min-interval").value);
      form.set("interval_max", document.getElementById("max-interval").value);
      form.set("random_delay", document.getElementById("random-seconds").checked);
      const res = await fetch("/start-bot", { method: "POST", body: form });
      const json = await res.json();
      if (res.ok) {
        alert("Bot started");
      } else {
        alert("Error: " + json.error);
      }
    };
  </script>
</body>
</html>
